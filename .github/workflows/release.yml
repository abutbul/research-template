name: Release Research Paper and Blog Post

on:
  push:
    tags:
      - 'v*'  # Triggers on version tags like v1.0.0, v1.2.3, etc.

permissions:
  contents: write

jobs:
  export-slidev:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
        cache-dependency-path: 'slidev/package.json'
        
    - name: Install Slidev dependencies
      run: |
        echo "ðŸ“¦ Installing Slidev dependencies..."
        cd slidev
        npm install
        echo "âœ… Dependencies installed"
        
    - name: Export Slidev presentation to PDF
      run: |
        echo "ðŸ”„ Exporting Slidev presentation to PDF..."
        cd slidev
        
        echo "ðŸ“ Contents of slidev directory:"
        ls -la
        
        echo "ðŸ“ Looking for presentation files..."
        find . -name "*.md" -type f | head -10
        
        # Try to find the main presentation file
        if [ -f "slides.md" ]; then
          MAIN_FILE="slides.md"
        elif [ -f "index.md" ]; then
          MAIN_FILE="index.md"
        elif [ -f "presentation.md" ]; then
          MAIN_FILE="presentation.md"
        else
          # Find any .md file in the root
          MAIN_FILE=$(find . -maxdepth 1 -name "*.md" -type f | head -1)
        fi
        
        if [ -z "$MAIN_FILE" ]; then
          echo "âŒ No main presentation file found"
          echo "Available files:"
          ls -la
          exit 1
        fi
        
        echo "ðŸ“„ Using main file: $MAIN_FILE"
        
        # Export using the found file
        npx slidev export "$MAIN_FILE" --format pdf --output slides-export.pdf
        echo "âœ… Slidev PDF export complete"
        
    - name: Verify PDF export
      run: |
        echo "ðŸ” Verifying PDF export..."
        if [ -f "slidev/slides-export.pdf" ]; then
          echo "âœ… Slidev PDF exported successfully: slides-export.pdf"
          echo "ðŸ“ PDF size: $(du -h slidev/slides-export.pdf | cut -f1)"
        else
          echo "âŒ Slidev PDF export failed"
          exit 1
        fi
        
    - name: Upload Slidev PDF as artifact
      uses: actions/upload-artifact@v4
      with:
        name: slidev-presentation-pdf
        path: slidev/slides-export.pdf
        retention-days: 90

  render-and-release:
    runs-on: ubuntu-latest
    needs: export-slidev
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Download Slidev PDF artifact
      uses: actions/download-artifact@v4
      with:
        name: slidev-presentation-pdf
        path: slidev-artifact/
      
    - name: Set up Quarto
      uses: quarto-dev/quarto-actions/setup@v2
      with:
        tinytex: true  # Install TinyTeX for PDF rendering
      
    - name: Configure Chrome for headless PDF rendering
      run: |
        echo "ðŸ”§ Configuring Chrome for CI environment..."
        # Install Chrome dependencies and virtual display
        sudo apt-get update
        sudo apt-get install -y xvfb fonts-liberation libxss1 libappindicator3-1 libindicator7 xdg-utils
        
        # Configure Chrome for headless rendering
        export CHROME_BIN=/usr/bin/google-chrome
        export DISPLAY=:99.0
        
        # Start virtual display
        Xvfb :99 -screen 0 1024x768x24 > /dev/null 2>&1 &
        sleep 2
        
        # Test Chrome installation and capabilities
        echo "Testing Chrome installation..."
        google-chrome --version
        google-chrome --headless --disable-gpu --no-sandbox --dump-dom --virtual-time-budget=1000 https://www.google.com > /dev/null
        echo "âœ… Chrome configuration complete"
        
        # Set Chrome flags for Quarto
        echo 'QUARTO_CHROME_ARGS="--no-sandbox --disable-dev-shm-usage --disable-gpu --disable-extensions --disable-plugins --disable-background-timer-throttling --disable-backgrounding-occluded-windows --disable-renderer-backgrounding --disable-features=TranslateUI --disable-ipc-flooding-protection --headless=new --virtual-time-budget=30000"' >> $GITHUB_ENV
    
    - name: Install additional LaTeX packages
      run: |
        echo "ðŸ“¦ Installing additional LaTeX packages..."
        # Ensure TinyTeX is in PATH
        export PATH="$HOME/bin:$PATH"
        export PATH="$HOME/.TinyTeX/bin/x86_64-linux:$PATH"
        
        # Install commonly needed packages
        tlmgr update --self || true
        tlmgr install amsmath amsfonts amssymb booktabs longtable array multirow wrapfig float colortbl pdflscape tabu threeparttable threeparttablex ulem makecell xcolor fancyvrb framed fvextra upquote lineno microtype parskip xurl bookmark footnotehyper || true
        echo "âœ… LaTeX packages installation complete"

    - name: Render research paper PDF
      run: |
        echo "ðŸ”„ Rendering research paper PDF..."
        cd research_paper
        quarto render --to pdf
        cd ..
        echo "âœ… Research paper PDF rendering complete"

    - name: Discover and render blog posts to PDF
      run: |
        echo "ðŸ” Discovering blog posts in blog_posts/ directory..."
        
        # Check if blog_posts directory exists
        if [ ! -d "blog_posts" ]; then
          echo "âŒ blog_posts directory not found"
          exit 1
        fi
        
        # Find all BLOG-POST*.md files
        BLOG_FILES=$(find blog_posts -name "BLOG-POST*.md" -type f | sort)
        
        if [ -z "$BLOG_FILES" ]; then
          echo "âŒ No BLOG-POST*.md files found in blog_posts/"
          exit 1
        fi
        
        echo "ðŸ“ Found blog posts:"
        echo "$BLOG_FILES"
        
        # Render each blog post
        for blog_file in $BLOG_FILES; do
          echo "ðŸ”„ Rendering $blog_file to PDF..."
          quarto render "$blog_file" --to pdf
          echo "âœ… Rendered $blog_file to PDF"
        done
        
        echo "âœ… All blog posts rendered to PDF"

    - name: Cleanup processes
      if: always()
      run: |
        echo "ðŸ§¹ Cleaning up any hanging processes..."
        # Kill any hanging Chrome processes
        pkill -f chrome || true
        pkill -f chromium || true
        # Kill virtual display
        pkill -f Xvfb || true
        echo "âœ… Process cleanup complete"

    - name: Verify rendered files
      run: |
        echo "ðŸ” Verifying rendered files..."
        
        # Research paper PDF
        PDF_FILE=$(find research_paper -maxdepth 2 -name "*.pdf" -type f | head -1)
        if [ -n "$PDF_FILE" ]; then
          echo "âœ… Research PDF file found: $PDF_FILE"
          echo "PDF_FILENAME=$(basename \"$PDF_FILE\")" >> $GITHUB_ENV
          echo "PDF_FILE=$PDF_FILE" >> $GITHUB_ENV
        else
          echo "âŒ No PDF file found in research_paper/"
          exit 1
        fi
        
        # Blog post PDFs
        BLOG_FILES=$(find blog_posts -name "BLOG-POST*.md" -type f | sort)
        for blog_file in $BLOG_FILES; do
          pdf_file="${blog_file%.md}.pdf"
          if [ -f "$pdf_file" ]; then
            echo "âœ… Blog PDF file exists: $pdf_file"
          else
            echo "âŒ Blog PDF file missing: $pdf_file"
            exit 1
          fi
        done

        echo "âœ… All required PDF files verified"

    - name: Package rendered files
      run: |
        echo "ðŸ“¦ Packaging rendered files..."
        mkdir -p release
        # Copy Slidev PDF to release directory
        if [ -f "slidev-artifact/slides-export.pdf" ]; then
          cp slidev-artifact/slides-export.pdf release/research-template-slides-${GITHUB_REF_NAME}.pdf
          echo "âœ… Copied Slidev presentation PDF"
        else
          echo "âš ï¸ Slidev PDF not found, skipping"
        fi
        # Copy research paper PDF
        if [ -n "$PDF_FILE" ] && [ -f "$PDF_FILE" ]; then
          cp "$PDF_FILE" release/
          echo "âœ… Copied research PDF: $(basename \"$PDF_FILE\")"
        else
          echo "âš ï¸ PDF not found, skipping PDF packaging"
        fi
        # Copy blog post PDFs
        BLOG_FILES=$(find blog_posts -name "BLOG-POST*.md" -type f | sort)
        for blog_file in $BLOG_FILES; do
          pdf_file="${blog_file%.md}.pdf"
          if [ -f "$pdf_file" ]; then
            blog_basename=$(basename "$blog_file" .md)
            cp "$pdf_file" "release/${blog_basename}.pdf"
            echo "âœ… Copied blog PDF: ${blog_basename}.pdf"
          fi
        done
        echo "âœ… All PDFs copied to release directory"

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ github.ref }}
        name: Release ${{ github.ref_name }}
        files: release/*
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Clean up temporary files
      run: |
        echo "ðŸ§¹ Cleaning up temporary files..."
        rm -f blog-post-temp.qmd blog-post-temp.html
        rm -rf blog-post-temp_files
        echo "âœ… Cleanup complete"

    - name: List generated files
      run: |
        echo "ðŸ“‹ Generated files:"
        ls -la release/
        echo ""
        echo "ðŸ“ Package sizes:"
        du -h release/*
        
    - name: Job Summary
      if: success()
      run: |
        echo "## ðŸŽ‰ Release ${{ github.ref_name }} Created Successfully!" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“¦ Generated Packages:" >> $GITHUB_STEP_SUMMARY
        echo "- **Research Paper PDF**: \`${PDF_FILENAME}\` (uncompressed)" >> $GITHUB_STEP_SUMMARY
        echo "- **Slidev Presentation**: \`research-template-slides-${{ github.ref_name }}.pdf\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ Blog Post PDFs:" >> $GITHUB_STEP_SUMMARY
        BLOG_FILES=$(find blog_posts -name "BLOG-POST*.md" -type f | sort)
        for blog_file in $BLOG_FILES; do
          blog_basename=$(basename "$blog_file" .md)
          echo "- **${blog_basename^^}**: \`${blog_basename}.pdf\`" >> $GITHUB_STEP_SUMMARY
        done
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ”— Links:" >> $GITHUB_STEP_SUMMARY
        echo "- [View Release](${{ github.server_url }}/${{ github.repository }}/releases/tag/${{ github.ref_name }})" >> $GITHUB_STEP_SUMMARY
        echo "- [Download All Assets](${{ github.server_url }}/${{ github.repository }}/releases/expanded_assets/${{ github.ref_name }})" >> $GITHUB_STEP_SUMMARY